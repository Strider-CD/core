{"version":3,"sources":["../../lib/primus-handlers/index.js"],"names":[],"mappings":";;AAAA,IAAI,SAAS,QAAQ,QAAR,CAAb;AACA,IAAI,QAAQ,QAAQ,cAAR,CAAZ;AACA,IAAI,MAAM,QAAQ,KAAR,CAAV;AACA,IAAI,SAAS,QAAQ,aAAR,EAAuB,MAAvB,CAAb;;AAEA,IAAI,oBAAoB,QAAQ,eAAR,CAAxB;AACA,IAAI,kBAAkB,QAAQ,aAAR,CAAtB;AACA,IAAI,iBAAiB,QAAQ,YAAR,CAArB;;AAEA,IAAI,aAAa,IAAI,MAAJ,GAAa,IAAb,CAAkB;AACjC,QAAM,IAAI,MAAJ,GAAa,IAAb,EAD2B;AAEjC,QAAM,IAAI,MAAJ,GAAa,IAAb,CAAkB,CACtB,QADsB,EACZ,QADY,EACF,MADE,EACM,OADN,EACe,MADf,EACuB,MADvB,EAEtB,kBAFsB,CAAlB,EAGH,QAHG,EAF2B;AAMjC,OAAK,IAAI,MAAJ,GAAa,QAAb;AAN4B,CAAlB,CAAjB;;AASA,SAAS,aAAT,CAAwB,UAAxB,EAAoC;AAClC,SAAO,WAAW,UAAX,CAAP;AACD;;AAED,SAAS,UAAT,CAAqB,MAArB,EAA6B;AAC3B,MAAI,SAAS,OAAO,OAAO,QAAd,EAAwB,EAAxB,CAAb;AACA,SAAO,GAAP,CAAW,OAAX,EAAoB,KAApB;;AAEA,SAAO,EAAP,CAAU,YAAV,EAAwB,UAAU,KAAV,EAAiB;AACvC,WAAO,KAAP,CAAc,2BAAyB,MAAM,EAAG,GAAhD;AACA,UAAM,EAAN,CAAS,MAAT,EAAiB,UAAU,IAAV,EAAgB;AAC/B,UAAI,QAAJ,CAAa,IAAb,EAAmB,UAAnB,EAA+B,UAAU,GAAV,EAAe,GAAf,EAAoB;AACjD,YAAI,GAAJ,EAAS,OAAO,KAAP,CAAa,mCAAb,EAAkD,GAAlD,EAAT,KACK,eAAe,KAAf,EAAsB,IAAtB;AACN,OAHD;AAID,KALD;AAMD,GARD;AASA,SAAO,MAAP;AACD;;AAED,SAAS,cAAT,CAAyB,KAAzB,EAAgC,IAAhC,EAAsC;AACpC,UAAQ,KAAK,IAAb;AACE,SAAK,YAAL;AACE,wBAAkB,KAAlB,EAAyB,IAAzB;AACA;AACF,SAAK,QAAL;AACE;AACA,wBAAkB,KAAlB,EAAyB,IAAzB;AACA;AACF,SAAK,QAAL;AACE;AACA,wBAAkB,KAAlB,EAAyB,IAAzB;AACA;AACF,SAAK,MAAL;AACE,sBAAgB,KAAhB,EAAuB,IAAvB;AACA;AACF,SAAK,OAAL;AACE,sBAAgB,KAAhB,EAAuB,IAAvB;AACA;AACF,SAAK,MAAL;AACE,qBAAe,KAAf,EAAsB,IAAtB;AACA;AACF,SAAK,MAAL;AACE,qBAAe,KAAf,EAAsB,IAAtB;AACA;AAvBJ;AAyBD;;AAED,OAAO,OAAP,GAAiB,aAAjB","file":"index.js","sourcesContent":["var Primus = require('primus')\nvar Rooms = require('primus-rooms')\nvar Joi = require('joi')\nvar logger = require('../util/log')(module)\n\nvar handleDroneOutput = require('./droneOutput')\nvar handleJoinLeave = require('./joinLeave')\nvar handlePingPong = require('./pingPong')\n\nvar baseSchema = Joi.object().keys({\n  room: Joi.string().guid(),\n  type: Joi.string().only([\n    'stdout', 'stderr', 'join', 'leave', 'ping', 'pong',\n    'jobs.job.changed'\n  ]).required(),\n  msg: Joi.object().required()\n})\n\nfunction PrimusHandler (httpServer) {\n  return PrimusInit(httpServer)\n}\n\nfunction PrimusInit (server) {\n  var primus = Primus(server.listener, {})\n  primus.use('rooms', Rooms)\n\n  primus.on('connection', function (spark) {\n    logger.debug(`connection from spark: ${spark.id}`)\n    spark.on('data', function (data) {\n      Joi.validate(data, baseSchema, function (err, res) {\n        if (err) logger.debug('Received malformed primus message', err)\n        else processMessage(spark, data)\n      })\n    })\n  })\n  return primus\n}\n\nfunction processMessage (spark, data) {\n  switch (data.type) {\n    case 'outputCtrl':\n      handleDroneOutput(spark, data)\n      break\n    case 'stdout':\n      // TODO: auth code for drone\n      handleDroneOutput(spark, data)\n      break\n    case 'stderr':\n      // TODO: auth code for drone\n      handleDroneOutput(spark, data)\n      break\n    case 'join':\n      handleJoinLeave(spark, data)\n      break\n    case 'leave':\n      handleJoinLeave(spark, data)\n      break\n    case 'ping':\n      handlePingPong(spark, data)\n      break\n    case 'pong':\n      handlePingPong(spark, data)\n      break\n  }\n}\n\nmodule.exports = PrimusHandler\n"]}