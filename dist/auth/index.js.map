{"version":3,"sources":["../../lib/auth/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var Bcrypt = require('bcryptjs')\nvar Drone = require('../models/drone')\nvar User = require('../models/user')\nvar jwt = require('jwt-simple')\nvar uuid = require('node-uuid')\nvar config = require('config')\nvar logger = require('../util/log.js')(module)\n\nfunction droneBasicAuth (request, name, secret, callback) {\n  Drone.findByQuery({'name': name}).then(function (list) {\n    if (list.length < 1) {\n      return callback(null, false)\n    }\n\n    let drone = list[0]\n    Bcrypt.compare(secret, drone.secret, function (err, isValid) {\n      return callback(err, isValid, { id: drone.id, name: drone.name })\n    })\n  }).then(null, function (err) {\n    return callback(err, false)\n  })\n}\n\nfunction userBasicAuth (request, name, secret, callback) {\n  if (name === 'guest') {\n    return callback(null, true, { id: uuid.v1(), name: 'guest' })\n  }\n  User.findByQuery({'name': name}).then(function (list) {\n    if (list.length < 1) {\n      return callback(null, false)\n    }\n\n    let user = list[0]\n    Bcrypt.compare(secret, user.secret, function (err, isValid) {\n      return callback(err, isValid, { id: user.id, name: user.name })\n    })\n  }).then(null, function (err) {\n    return callback(err, false)\n  })\n}\n\nfunction jwtAuth (decoded, request, callback) {\n  if (decoded.type === 'drone') {\n    return droneJwtAuth(decoded, request, callback)\n  } else if (decoded.type === 'user') {\n    return userJwtAuth(decoded, request, callback)\n  } else if (decoded.type === 'guest') {\n    return guestJwtAuth(decoded, request, callback)\n  } else {\n    return callback(new Error('auth unknown type ' + decoded.type), false)\n  }\n}\n\nfunction primusJwtAuth (req, authorized) {\n  var token = req.query.token\n  var error\n  var payload\n\n  if (!token) {\n    error = new Error('Missing access token')\n    console.error(error.message)\n    return authorized(error)\n  }\n  try {\n    payload = jwt.decode(token, config.jwtSecret)\n  } catch (e) {\n    return authorized(e)\n  }\n\n  jwtAuth(payload, req, function (error, success) {\n    if (error) return authorized(error)\n    if (!(success)) {\n      error = new Error('primusJwtAuth: Invalid access token')\n      console.error(error.message)\n      return authorized(error)\n    } else {\n      req.decoded_token = payload\n      authorized()\n    }\n  })\n}\n\nfunction droneJwtAuth (decoded, request, callback) {\n  Drone.findByQuery({'id': decoded.parent}).then(function (list) {\n    if (list.length < 1) return callback(null, false)\n    var drone = list[0]\n    let valid = drone.session.valid\n    let exp = drone.session.exp\n    if (valid !== decoded.valid || exp !== decoded.exp) {\n      return callback(null, false)\n    }\n    if (exp < new Date().getTime() || !(valid)) {\n      drone.session = undefined\n      Drone.update(drone.id, drone).then(function (id) {\n        return callback('token no longer valid', false)\n      }).then(null, function (err) {\n        return callback(err, false)\n      })\n    } else {\n      // session still alive\n      return callback(null, true, decoded)\n    }\n  }).then(null, function (err) {\n    callback(err, false)\n  })\n}\n\nfunction userJwtAuth (decoded, request, callback) {\n  User.findByQuery({'id': decoded.parent}).then(function (list) {\n    if (list.length < 1) return callback(null, false)\n    var user = list[0]\n    let valid = user.session.valid\n    let exp = user.session.exp\n    if (valid !== decoded.valid || exp !== decoded.exp) {\n      return callback(null, false)\n    }\n    if (exp < new Date().getTime() || !(valid)) {\n      user.session = undefined\n      User.update(user.id, user).then(function (id) {\n        return callback('token no longer valid', false)\n      }).then(null, function (err) {\n        logger.debug(err)\n        return callback(err, false)\n      })\n    } else {\n      // session still alive\n      return callback(null, true, decoded)\n    }\n  }).then(null, function (err) {\n    console.error(err)\n    callback(err, false)\n  })\n}\n\nfunction guestJwtAuth (decoded, request, callback) {\n  if (!(request.method === 'get' || request.method === 'GET')) {\n    logger.warn('Guest user tried to use a http method other than \"get\"!')\n  }\n  if (decoded.exp > new Date().getTime() && decoded.valid) {\n    return callback(null, true)\n  } else {\n    return callback(new Error('Guest token no longer valid'), false)\n  }\n}\n\nmodule.exports = {\n  droneBasicAuth: droneBasicAuth,\n  userBasicAuth: userBasicAuth,\n  jwtAuth: jwtAuth,\n  primusJwtAuth: primusJwtAuth\n}\n"]}