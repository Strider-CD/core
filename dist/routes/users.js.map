{"version":3,"sources":["../../lib/routes/users.js"],"names":[],"mappings":"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","file":"users.js","sourcesContent":["'use strict'\n\nvar config = require('config')\nvar web = require('hapi-decorators')\nvar User = require('../models/user')\nvar bcrypt = require('bcryptjs')\nvar uuid = require('node-uuid')\nvar JWT = require('jsonwebtoken')\nvar userPath = config.apiPrefix + 'users'\n\n@web.controller(userPath)\nclass Users {\n  @web.get('/')\n  all (request, reply) {\n    User.findByQuery({}).then(function (list) {\n      reply(list.map((item) => {\n        if (item.secret) item.secret = undefined // filter out secret before replying\n      }))\n    }).then(null, function (err) {\n      reply(err).code(503)\n    })\n  }\n\n  @web.post('/')\n  create (request, reply) {\n    var user = request.payload\n    if (!(user.secret) || !(user.name)) return reply('malformed request').code(400)\n    // hash secret and store user in DB\n    bcrypt.genSalt(10, function (err, salt) {\n      if (err) return reply(err).code(503)\n      bcrypt.hash(user.secret, salt, function (err, hash) {\n        if (err) return reply(err).code(503)\n        user.secret = hash\n        user.save(user).then(function (id) {\n          reply(id)\n        }).then(null, function (error) {\n          reply(error).code(503)\n        })\n      })\n    })\n  }\n\n  @web.config({\n    auth: 'userBasicAuth'\n  })\n  @web.get('/login')\n  login (request, reply) {\n    let id = request.auth.credentials.id\n    let name = request.auth.credentials.name\n    if (name === 'guest') {\n      let session = {\n        parent: id,\n        id: id,\n        type: 'guest',\n        valid: true,\n        exp: new Date().getTime() + 24 * 60 * 60 * 1000 // expires in 24 hours\n      }\n      let token = JWT.sign(session, config.jwtSecret)\n      return reply({token: token}).header('Authorization', token)\n    }\n    User.findByQuery({'id': id}).then(function (list) {\n      if (list.length < 1) return reply('').code(503)\n      let user = list[0]\n      user.session = {\n        parent: id,\n        id: uuid.v1(),\n        type: 'user',\n        valid: true,\n        exp: new Date().getTime() + 24 * 60 * 60 * 1000 // expires in 24 hours\n      }\n      let token = JWT.sign(user.session, config.jwtSecret)\n      User.update(user.id, user).then(function (id) {\n        reply({token: token}).header('Authorization', token)\n      }).then(null, function (err) {\n        reply(err).code(404)\n      })\n    }).then(null, function (err) {\n      reply(err).code(503)\n    })\n  }\n}\n\nmodule.exports = Users\n"]}