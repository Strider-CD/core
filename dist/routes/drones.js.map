{"version":3,"sources":["../../lib/routes/drones.js"],"names":[],"mappings":"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","file":"drones.js","sourcesContent":["'use strict'\n\nvar config = require('config')\nvar web = require('hapi-decorators')\nvar Drone = require('../models/drone')\nvar uuid = require('node-uuid')\nvar JWT = require('jsonwebtoken')\nvar dronePath = config.apiPrefix + 'drones'\n\n@web.controller(dronePath)\nclass Drones {\n  /*\n   * Returns all drones\n   */\n  @web.get('/')\n  all (request, reply) {\n    Drone.findByQuery({}).then(function (list) {\n      var returnList = clone(list)\n      returnList.slice().map((item) => {\n        if (item.session) delete item.session // filter out session before replying\n      })\n      reply(returnList)\n    }).catch(function (err) {\n      reply(err).code(503)\n    })\n  }\n\n  /*\n   * Saves a drone and replies a token\n   */\n  @web.post('/')\n  create (request, reply) {\n    var drone = request.payload\n    if (!(drone.name)) return reply('malformed request').code(400)\n\n    Drone.save(drone).then(function (id) {\n      Drone.findByQuery({'id': id}).then(function (list) {\n        if (!list.length) return reply('').code(503)\n\n        let drone = list[0]\n        drone.session = generateSession(id)\n        let token = JWT.sign(drone.session, config.jwtSecret)\n        drone.token = token\n\n        Drone.update(drone.id, drone).then(function (id) {\n          reply(drone)\n        }).then(null, function (err) {\n          reply(err).code(503)\n        })\n      }).then(null, function (error) {\n        reply(error).code(503)\n      })\n    })\n  }\n\n  /*\n   * Return a single drone by id\n   */\n  @web.get('/{id}')\n  single (request, reply) {\n    Drone.findOneById(request.params.id)\n      .then((drone) => {\n        reply(drone)\n      })\n      .catch((error) => reply(error.message).code(error.code || 500))\n  }\n\n  /*\n   * Refresh session and token information for a drone\n   */\n  @web.get('/session/refresh')\n  login (request, reply) {\n    let id = request.auth.credentials.parent\n    Drone.findByQuery({'id': id}).then(function (list) {\n      if (!list.length) return reply('').code(503)\n\n      let drone = list[0]\n      drone.session = generateSession(id)\n      let token = JWT.sign(drone.session, config.jwtSecret)\n\n      Drone.update(drone.id, drone).then(function (id) {\n        reply({text: 'Check auth headers for your token'}).header('Authorization', token)\n      }).then(null, function (err) {\n        reply(err).code(404)\n      })\n    }).then(null, function (err) {\n      reply(err).code(503)\n    })\n  }\n\n  @web.post('/checkin/{token}')\n  checkIn (request, reply) {\n    var token = request.params.token\n\n    if (token) {\n      JWT.verify(token, config.jwtSecret, function (err, decoded) {\n        if (err) {\n          return reply(err).code(401)\n        }\n\n        Drone.update(decoded.parent, { status: 'active' })\n          .then((id) => {\n            reply()\n          })\n          .catch((error) => {\n            reply(error).code(500)\n          })\n      })\n    } else {\n      reply('missing token').code(400)\n    }\n  }\n}\n\nfunction generateSession (id) {\n  return {\n    parent: id,\n    id: uuid.v1(),\n    type: 'drone',\n    valid: true,\n    exp: new Date().getTime() + 5 * 365 * 24 * 60 * 60 * 1000 // expires in 5 years\n  }\n}\n\nfunction clone (obj) {\n  return JSON.parse(JSON.stringify(obj))\n}\n\nmodule.exports = Drones\n"]}