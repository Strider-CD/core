{"version":3,"sources":["../lib/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import Hapi from 'hapi'\nimport hapiAuthBasic from 'hapi-auth-basic'\nimport hapiAuthJWT from 'hapi-auth-jwt2'\nimport hapiAsyncHandler from 'hapi-async-handler'\nimport good from 'good'\nimport bcrypt from 'bcryptjs'\nimport config from 'config'\nimport mongoose from 'mongoose'\nimport EventEmitter from 'eventemitter3'\nimport auth from './auth'\nimport setupLogger from './util/log'\nimport routes from './routes'\nimport eventHandlers from './event-handlers'\nimport PrimusHandler from './primus-handlers'\nimport User from './models/user'\nimport Project from './models/project'\n\nconst logger = setupLogger(module)\nvar server = new Hapi.Server({\n  connections: {\n    routes: {\n      cors: true\n    }\n  }\n})\n\nserver.connection({\n  port: config.port\n})\n\nvar primus = new PrimusHandler(server)\nprimus.authorize(auth.primusJwtAuth)\nserver.primus = primus\n\nvar emitter = new EventEmitter()\neventHandlers(emitter, primus)\n\nvar hapiPlugins = [\n  hapiAuthBasic,\n  hapiAuthJWT,\n  hapiAsyncHandler,\n  {\n    register: good,\n    options: {\n      reporters: [{\n        reporter: require('good-console'),\n        events: { log: ['error', 'medium'], error: '*' }\n      }]\n    }\n  }\n]\n\nserver.register(hapiPlugins, function (err) {\n  if (err) {\n    return console.error(err)\n  }\n  // Basic auth for drones\n  server.auth.strategy('droneBasicAuth', 'basic', { validateFunc: auth.droneBasicAuth })\n  // Basic auth for users\n  server.auth.strategy('userBasicAuth', 'basic', { validateFunc: auth.userBasicAuth })\n  // JWT for drones, users and API calls (using user token)\n  server.auth.strategy('jwtAuth', 'jwt', {\n    key: config.jwtSecret,\n    validateFunc: auth.jwtAuth,\n    verifyOptions: { algorithms: [ 'HS256' ] }\n  })\n\n  server.auth.default('jwtAuth')\n  var routeList = routes(emitter)\n  server.route(routeList)\n})\n\n// Setup on first start\nsetUpAdminUser()\nsetUpDefaultProject()\n\nif (!module.parent) {\n  server.start(function (err) {\n    if (err) {\n      return console.error(err)\n    }\n\n    if (!(process.env.STRIDER_ADMIN_USER) || !(process.env.STRIDER_ADMIN_PWD)) {\n      logger.warn('WARNING: using default admin user name and password')\n    }\n\n    logger.info('Server started ' + server.info.uri)\n  })\n}\n\nfunction setUpAdminUser () {\n  var salt = bcrypt.genSaltSync(10)\n  var admin = {\n    name: config.adminUser,\n    secret: bcrypt.hashSync(config.adminPwd, salt),\n    role: 'admin',\n    projects: ['default'],\n    session: {}\n  }\n  if (config.dbType === 'mongodb') {\n    require('deasync').loopWhile(function () {\n      return mongoose.connection.readyState !== 1\n    })\n    if (config.clearDB) {\n      mongoose.connection.db.dropDatabase()\n      mongoose.disconnect()\n      mongoose.connect(config.mongoDbURI)\n    }\n    require('deasync').loopWhile(function () {\n      return mongoose.connection.readyState !== 1\n    })\n  }\n  User.findByQuery({name: config.adminUser}).then(function (list) {\n    if (list.length === 0) {\n      User.save(admin).then(function (id) {\n        logger.info('created admin user with id ' + id)\n        global.striderReady = true\n      }).then(null, function (err) {\n        logger.warn('failed to create admin user ' + err)\n      })\n    } else {\n      logger.warn('admin user exists and will not be replaced!')\n      global.striderReady = true\n    }\n  })\n}\n\nfunction setUpDefaultProject () {\n  var project = {\n    name: config.defaultProjectName,\n    id: config.defaultProjectId,\n    environments: [],\n    provider: {\n      type: 'github'\n    }\n  }\n  if (config.dbType === 'mongodb') {\n    require('deasync').loopWhile(function () {\n      return mongoose.connection.readyState !== 1\n    })\n    if (config.clearDB) {\n      mongoose.connection.db.dropDatabase()\n      mongoose.disconnect()\n      mongoose.connect(config.mongoDbURI)\n    }\n    require('deasync').loopWhile(function () {\n      return mongoose.connection.readyState !== 1\n    })\n  }\n  Project.findByQuery({name: config.defaultProjectName}).then(function (list) {\n    if (list.length === 0) {\n      Project.save(project).then(function (id) {\n        logger.info('created default project with id ' + id)\n      }).then(null, function (err) {\n        logger.warn('failed to create admin user ' + err)\n      })\n    } else {\n      logger.warn('default project exists and will not be replaced!')\n    }\n  })\n}\n\nmodule.exports = server\n"]}