{"version":3,"sources":["../../lib/models/simple-collection.js"],"names":[],"mappings":"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","file":"simple-collection.js","sourcesContent":["'use strict'\n\nvar Joi = require('joi')\nvar uuid = require('node-uuid')\nvar v = require('validator')\nvar Promise = require('bluebird')\nvar Loki = require('lokijs')\nvar prettyJson = require('../util/prettyPrint.js')\nvar logger = require('../util/log.js')(module)\n\nclass SimpleCollection {\n  constructor (schema) {\n    this.schema = schema // a joi schema\n    this.db = new Loki(`${this.constructor.name}.json`)\n    this.col = this.db.addCollection(this.constructor.name)\n  }\n\n  save (item) {\n    if (!item.id || !v.isUUID(item.id)) {\n      item.id = uuid.v1() // date time based ids\n    }\n\n    var validation = this.validate(item, this.schema.optionalKeys('id'))\n\n    if (!validation.error) {\n      this.col.insert(item)\n      return Promise.resolve(item.id)\n    } else {\n      let errorMsg = `${this.constructor.name}.save() item failed to validate`\n\n      return Promise.reject({\n        message: errorMsg,\n        details: validation.error\n      })\n    }\n  }\n\n  update (id, item) {\n    // var validation = this.validate(item, this.schema.optionalKeys('id'))\n    var errorMsg = `${this.constructor.name}.save() item failed to update: ${prettyJson(item)}`\n    var res = this.col.findOne({'id': id})\n\n    if (res) {\n      // copy meta information from 'old' entry\n      Object.assign(res, item)\n\n      try {\n        this.col.update(res)\n      } catch (err) {}\n\n      return Promise.resolve(res.id)\n    }\n\n    return Promise.reject(errorMsg)\n  }\n\n  findOneById (id) {\n    var res = this.col.findOne({'id': id})\n    if (res) {\n      return Promise.resolve(res)\n    }\n\n    var errorMsg = `${this.constructor.name}.findOneById() item not found: ${id}`\n    return Promise.reject({ message: errorMsg, code: 404 })\n  }\n\n  findOneByQuery (query) {\n    var res = this.col.findOne(query)\n\n    if (res) {\n      return Promise.resolve(res)\n    }\n\n    var errorMsg = `${this.constructor.name}.findOneById() item not found: ${prettyJson(query)}`\n    return Promise.reject({ message: errorMsg })\n  }\n\n  findById (id) {\n    var res = this.col.find({'id': id})\n\n    if (res) {\n      if (res.length > 0) return Promise.resolve(res)\n    }\n\n    var errorMsg = `${this.constructor.name}.findOneById() item not found: ${id}`\n    return Promise.reject({ message: errorMsg })\n  }\n\n  findByQuery (query) {\n    var res = this.col.find(query)\n\n    if (res) {\n      return Promise.resolve(res)\n    }\n\n    var errorMsg = `${this.constructor.name}.findByQuery() item not found`\n\n    return Promise.reject({ message: errorMsg })\n  }\n\n  remove (item) {\n    this.col.remove(item)\n    return Promise.resolve()\n  }\n\n  purge () {\n    this.col.removeDataOnly()\n  }\n\n  validate (item, optionalSchema) {\n    var validateOptions = {\n      allowUnknown: true\n    }\n    var validation\n\n    if (optionalSchema) {\n      validation = Joi.validate(item, optionalSchema, validateOptions)\n    } else {\n      validation = Joi.validate(item, this.schema, validateOptions)\n    }\n\n    if (validation.error) logger.debug(validation.error)\n\n    return validation\n  }\n}\n\nmodule.exports = SimpleCollection\n"]}